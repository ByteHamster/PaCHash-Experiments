# PaCHash-Experiments

This repository contains benchmarks for [PaCHash](https://github.com/ByteHamster/PaCHash).
The setup of the development machine and plot generation needs a large number of steps.
We therefore strongly recommend using the docker image.

### Variant A: Running experiments with Docker (recommended)

To build the docker image with a pre-compiled PaCHash install and all benchmark utilities, run the following command.
Compiler warnings in competitors' code are expected and should not prevent building the docker image.
Building the container takes about 15 minutes.

```
docker build -t pachash .
```

The run scripts we provide are simplified versions of the plots from our paper.
They run fewer iterations and output fewer data points, but run faster.
Each experiment can be started by changing the command of the docker image to generate the corresponding figure.


| Figure in paper | Launch command                | Estimated runtime  |
| :-------------- | :---------------------------- | :----------------- |
| 2               | todo                          |                    |
| 4               | /opt/dockerVolume/figure-4.sh | 30 minutes         |


```
docker run --interactive --tty -v "$(pwd)/scripts/dockerVolume:/opt/dockerVolume" pachash /opt/dockerVolume/figure-4.sh
```

Optionally, you can add the argument `-v "/path/to/ssd:/opt/testDirectory"` to mount your SSD into the container.
If you do not use the argument, a docker-internal volume is used.

### Variant B: Running the experiments on the host machine (not recommended)

We recommend that you use the docker image (like described above) to reproduce our results.
The docker image performs steps like setting up the plotting tools, applying patches to the competitors, and installing dependencies.

If you want to run the benchmarks on your host computer, you need to expect significantly more work and more digging into the code.
The `Dockerfile` might be helpful for setting up your host computer.

Our plots are generated by `sqlplot-tools`.
As we rely ob a feature that is not merged yet, please clone and install the following branch: https://github.com/lorenzhs/sqlplot-tools/tree/feature/attribute_mark

There are two types of benchmarks - the ones for PaCHash itself and the ones for competitor object stores.
First, we describe benchmarks for PaCHash configurations.

##### Benchmark type 1: PaCHash Configurations
Compares different configuration parameters of PaCHash.
The benchmarks consist of shell scripts that call examples from the main PaCHash repository.
To compile and test, execute something like the following:

```
mkdir build-pachash
cd build-pachash
cmake -DCMAKE_BUILD_TYPE=Release ../external/pachash
cmake --build . -j 8
../scripts/objectSizeBlocksFetched.sh /path/to/folder/on/ssd/filename.dat
```

The object store is generated under the given file name.
If the file exists, it is silently overwritten.
Note that the selected mount point must support `O_DIRECT` file access, so `/tmp` usually does not work.

##### Benchmark type 2: Comparison with Competitors
Compares PaCHash to competitors from the literature.
Included competitors:

- RocksDB
- LevelDB
- SILT
- RecSplit
- CHD

You need to apply the patches in the `patches` directory to modify the object stores,
so that we can benchmark their internal index data structures.
You can use the included helper script for that.

```
cd patches
./apply-patches.sh
cd ..
```

The following dependencies are needed to compile the competitors.
Please install them before continuing:

- cblas
- xerces-c
- googletest (libgtest-dev)

To compile, execute something like the following:

```
mkdir build
cd build 
cmake -DCMAKE_BUILD_TYPE=Release ..
cmake --build . -j 8
```

To run the full comparison plot from our paper you can use the following command.
On our machine with a very fast SSD, this takes about 3 hours.

```
./ObjectStoreComparison --path /path/to/folder/on/ssd  --delta_step 400k | tee comparisonPlot.txt
```

Note that the selected mount point must support `O_DIRECT` file access, so `/tmp` usually does not work.
To only run a smaller experiment for reproducibility, you can also run the following command.
On our machine with a very fast SSD, this takes about 10 minutes.

```
./ObjectStoreComparison --path /path/to/folder/on/ssd --delta_step 1M --repetitions 1 | tee comparisonPlot.txt
```

From the command output stored in `comparisonPlot.txt`, you can generate the main comparison plot using the following commands.

```
cd scripts
cp ../build/comparisonPlot.txt comparisonPlot.txt
sqlplot-tools largeComparisonPlot.tex
pdflatex largeComparisonPlot.tex
```

### License
The competitors in the `external` folder are licensed under their respective license.
The benchmark code is licensed under the [GPLv3](/LICENSE).
If you use the project in an academic context or publication, please cite our paper.
